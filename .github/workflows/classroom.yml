name: GitHub Classroom Workflow

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    name: Autograding
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: docker/setup-buildx-action@v2

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Build and push Docker images
        run: docker compose build --push

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${KUBECONFIG_CONTENT}" > ~/.kube/config
          kubectl config get-contexts
          kubectl cluster-info
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_CONTENT }}

      - name: Deploy reservation
        run: |
          helm upgrade --install reservation ./helm/microservice \
            -f helm/microservice/values-reservation.yaml \
            --namespace default

      - name: Deploy loyalty
        run: |
          helm upgrade --install loyalty ./helm/microservice \
            -f helm/microservice/values-loyalty.yaml \
            --namespace default

      - name: Deploy payment
        run: |
          helm upgrade --install payment ./helm/microservice \
            -f helm/microservice/values-payment.yaml \
            --namespace default

      - name: Deploy gateway
        run: |
          helm upgrade --install gateway ./helm/microservice \
            -f helm/microservice/values-gateway.yaml \
            --namespace default

      - name: Deploy gateway-worker
        run: |
          helm upgrade --install gateway-worker ./helm/microservice \
            -f helm/microservice/values-gateway-worker.yaml \
            --namespace default

      - name: Wait for services to become Ready
        run: |
          kubectl wait --namespace default --for=condition=available deploy/reservation-microservice --timeout=180s
          kubectl wait --namespace default --for=condition=available deploy/loyalty-microservice --timeout=180s
          kubectl wait --namespace default --for=condition=available deploy/payment-microservice --timeout=180s
          kubectl wait --namespace default --for=condition=available deploy/gateway-microservice --timeout=180s

      - name: Autograding
        uses: education/autograding@v1
        continue-on-error: true